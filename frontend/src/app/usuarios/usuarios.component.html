<div class="usuarios-wrapper">
  <app-sidebar></app-sidebar>

  <main class="usuarios-main">
    <header class="page-header">
      <h1 class="page-title">IURIS CONSULTUS S.A</h1>
    </header>

    <section class="usuarios-content">
      <div class="content-card">
        <div class="card-header">
          <div class="header-left">
            <h2 class="section-title">{{ isEditing() ? 'Editar Usuario' : 'Registro de Usuarios' }}</h2>
            <span class="active-users-link">Usuarios Activos: {{ activeUsersCount() }}</span>
          </div>
          <div class="control-module">
            <div class="control-row primary-controls">
              <div class="search-box">
                <img src="assets/icons/search-icon.svg" alt="Buscar" class="search-icon" />
                <input 
                  type="text" 
                  placeholder="Buscar por nombre, usuario..." 
                  class="search-input"
                  [value]="searchTerm()"
                  (input)="onSearch($event)"
                />
              </div>
              
              <div class="sort-controls">
                <select [value]="sortBy()" (change)="onSortChange($event)" class="sort-select">
                  <option value="date">Fecha</option>
                  <option value="username">Usuario</option>
                  <option value="role">Rol</option>
                  <option value="status">Estado</option>
                  <option value="lastAccess">Último Acceso</option>
                </select>
                <button (click)="toggleSortOrder()" class="sort-order-btn" [title]="sortOrder() === 'asc' ? 'Ascendente' : 'Descendente'">
                  <span class="sort-arrow" [class.asc]="sortOrder() === 'asc'">↓</span>
                </button>
                <button (click)="resetSort()" class="sort-reset-btn" title="Restablecer orden por defecto">↺</button>
              </div>
              
              <button (click)="toggleFilters()" class="filter-toggle-btn" [class.active]="showFilters() || hasActiveFilters()">
                <span class="filter-icon">⚙️</span> Filtros
                <span class="filter-dot" *ngIf="hasActiveFilters()"></span>
              </button>
            </div>

            <div class="control-row advanced-filters" *ngIf="showFilters()">
              <div class="filter-group">
                <label>Desde:</label>
                <input type="date" [value]="filterDateStart()" (change)="onDateStartChange($event)" class="filter-input">
              </div>
              <div class="filter-group">
                <label>Hasta:</label>
                <input type="date" [value]="filterDateEnd()" (change)="onDateEndChange($event)" class="filter-input">
              </div>
              <div class="filter-group">
                <label>Rol:</label>
                <select [value]="filterRole()" (change)="onRoleChange($event)" class="filter-select">
                  <option value="">Todos</option>
                  <option value="administrator">Administrador</option>
                  <option value="accountant">Contador</option>
                </select>
              </div>
              <div class="filter-group">
                <label>Estado:</label>
                <select [value]="filterStatus()" (change)="onStatusChange($event)" class="filter-select">
                  <option value="">Todos</option>
                  <option value="active">Activo</option>
                  <option value="inactive">Inactivo</option>
                </select>
              </div>
              
              <div class="filter-actions">
                <button (click)="clearFilters()" class="btn-clear">Limpiar Filtros</button>
              </div>
            </div>
          </div>
        </div>

        <div class="registration-form" *ngIf="showForm()">
          <form [formGroup]="registrationForm" (ngSubmit)="onSubmit()">
            <div class="form-row">
              <div class="form-field">
                <label for="cedula" class="field-label">Cédula:</label>
                <input
                  id="cedula"
                  type="text"
                  formControlName="cedula"
                  placeholder="Ingrese número de cédula"
                  class="field-input"
                  [class.error]="registrationForm.get('cedula')?.invalid && registrationForm.get('cedula')?.touched"
                />
              </div>
              <div class="form-field">
                <label for="email" class="field-label">Email:</label>
                <input
                  id="email"
                  type="email"
                  formControlName="email"
                  placeholder="Ingrese correo electrónico"
                  class="field-input"
                  [class.error]="registrationForm.get('email')?.invalid && registrationForm.get('email')?.touched"
                />
              </div>
              <div class="form-field" *ngIf="!isEditing()">
                <label for="password" class="field-label">Contraseña:</label>
                <input
                  id="password"
                  type="password"
                  formControlName="password"
                  placeholder="Ingrese contraseña"
                  class="field-input"
                  [class.error]="registrationForm.get('password')?.invalid && registrationForm.get('password')?.touched"
                />
              </div>
            </div>
            <div class="form-row">
              <div class="form-field">
                <label for="username" class="field-label">Usuario:</label>
                <input
                  id="username"
                  type="text"
                  formControlName="username"
                  placeholder="Ingrese nombre de usuario"
                  class="field-input"
                  [class.error]="registrationForm.get('username')?.invalid && registrationForm.get('username')?.touched"
                />
              </div>
              <div class="form-field">
                <label for="rol" class="field-label">Rol:</label>
                <select
                  id="rol"
                  formControlName="rol"
                  class="field-input"
                  [class.error]="registrationForm.get('rol')?.invalid && registrationForm.get('rol')?.touched"
                >
                  <option value="" disabled>Seleccione un rol</option>
                  <option value="administrator">Administrador</option>
                  <option value="accountant">Contador</option>
                </select>
              </div>
              <div class="form-field">
                <label class="field-label">Foto de Perfil</label>
                <div class="photo-upload-container">
                  <input
                    type="file"
                    id="profilePhoto"
                    accept="image/*"
                    class="photo-input"
                    (change)="onFileSelect($event)"
                    #photoInput
                  />
                  <div class="photo-preview" *ngIf="selectedPhoto()">
                    <img [src]="selectedPhoto()" alt="Preview" class="preview-image" />
                  </div>
                  <div class="photo-actions">
                    <button type="button" class="btn-upload" (click)="photoInput.click()">
                      Subir
                    </button>
                    <button type="button" class="btn-camera" (click)="onTakePhoto()">
                      Tomar foto
                    </button>
                  </div>
                </div>
              </div>
            </div>
            <div class="form-actions">
              <button type="button" class="btn-cancel" (click)="cancelEdit()">Cancelar</button>
              <button type="submit" class="btn-register" [disabled]="isLoading()">
                {{ isLoading() ? (isEditing() ? 'Actualizando...' : 'Registrando...') : (isEditing() ? 'Actualizar' : 'Registrar') }}
              </button>
            </div>
          </form>
          
          <div class="message error-message" *ngIf="errorMessage()">
            {{ errorMessage() }}
          </div>
          <div class="message success-message" *ngIf="successMessage()">
            {{ successMessage() }}
          </div>
        </div>

        <div class="users-table">
          <div class="table-header">
            <div class="header-cell nombre-col">Nombre</div>
            <div class="header-cell fecha-col">Fecha de Registro</div>
            <div class="header-cell ingreso-col">Último Ingreso</div>
            <div class="header-cell tiempo-col">Tiempo Activo</div>
            <div class="header-cell estado-col">Estado</div>
            <div class="header-cell acciones-col">Acciones</div>
          </div>

          <div class="table-body" *ngIf="!isLoading(); else loading">
            <div class="table-row" *ngFor="let user of paginatedData().users; let i = index">
              <div class="table-cell nombre-col">{{ user.fullName }}</div>
              <div class="table-cell fecha-col">{{ formatDate(user.createdAt) }}</div>
              <div class="table-cell ingreso-col">{{ formatDateTime(user.lastLogin) }}</div>
              <div class="table-cell tiempo-col">{{ calculateActiveTime(user.lastLogin) }}</div>
              <div class="table-cell estado-col">
                <label class="toggle-switch" [attr.aria-label]="'Toggle status for ' + user.fullName">
                  <input 
                    type="checkbox" 
                    [checked]="user.isActive"
                    (change)="toggleUserStatus(user)"
                  />
                  <span class="toggle-slider"></span>
                </label>
              </div>
              <div class="table-cell acciones-col">
                <div class="action-buttons">
                  <button 
                    *ngIf="isAdmin()" 
                    class="btn-action btn-view" 
                    (click)="openPasswordModal(user)" 
                    [attr.aria-label]="'Ver detalles de ' + user.fullName" 
                    title="Ver">
                    <svg width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M2 24C2 24 10 8 24 8C38 8 46 24 46 24C46 24 38 40 24 40C10 40 2 24 2 24Z" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M24 30C27.3137 30 30 27.3137 30 24C30 20.6863 27.3137 18 24 18C20.6863 18 18 20.6863 18 24C18 27.3137 20.6863 30 24 30Z" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </button>
                  <button class="btn-action btn-edit" (click)="startEdit(user)" [attr.aria-label]="'Editar usuario ' + user.fullName" title="Editar">
                    <svg width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M22 8H8C6.93913 8 5.92172 8.42142 5.17157 9.17157C4.42143 9.92171 4 10.9391 4 12V40C4 41.0609 4.42143 42.0783 5.17157 42.8284C5.92172 43.5786 6.93913 44 8 44H36C37.0609 44 38.0783 43.5786 38.8284 42.8284C39.5786 42.0783 40 41.0609 40 40V26M37 5C37.7956 4.20435 38.8748 3.75735 40 3.75735C41.1252 3.75735 42.2044 4.20435 43 5C43.7956 5.79564 44.2426 6.87478 44.2426 8C44.2426 9.12521 43.7956 10.2043 43 11L24 30L16 32L18 24L37 5Z" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <ng-template #loading>
            <div class="loading-state">Cargando usuarios...</div>
          </ng-template>
        </div>

        <div class="pagination" *ngIf="paginatedData().totalPages > 1">
          <button 
            class="page-btn" 
            (click)="prevPage()"
            [disabled]="currentPage() === 1"
          >
            &lt;
          </button>
          
          <ng-container *ngFor="let page of pageNumbers()">
            <button 
              *ngIf="page !== '...'"
              class="page-btn"
              [class.active]="page === currentPage()"
              (click)="isNumber(page) && goToPage(page)"
            >
              {{ page }}
            </button>
            <span *ngIf="page === '...'" class="page-ellipsis">...</span>
          </ng-container>
          
          <button 
            class="page-btn" 
            (click)="nextPage()"
            [disabled]="currentPage() === paginatedData().totalPages"
          >
            &gt;
          </button>
        </div>
      </div>
    </section>
  </main>

  <!-- Camera Modal -->
  <div class="camera-modal-overlay" *ngIf="showCamera()">
    <div class="camera-modal">
      <div class="camera-header">
        <h3>Tomar Foto de Perfil</h3>
        <button class="close-btn" (click)="closeCamera()">&times;</button>
      </div>
      
      <div class="camera-content">
        <div class="video-container">
          <video #videoElement autoplay playsinline muted></video>
          <canvas #canvasElement style="display: none;"></canvas>
        </div>
        
        <div class="error-message" *ngIf="cameraError()">
          {{ cameraError() }}
        </div>
      </div>

      <div class="camera-actions">
        <button type="button" class="btn-cancel" (click)="closeCamera()">Cancelar</button>
        <button type="button" class="btn-capture" (click)="capturePhoto()" [disabled]="!!cameraError()">
          Capturar
        </button>
      </div>
    </div>
  </div>

  <!-- Password Verification Modal -->
  <div class="password-modal-overlay" *ngIf="showPasswordModal()">
    <div class="password-modal">
      <div class="password-modal-header">
        <h3>Verificación de Seguridad</h3>
        <button class="close-btn" (click)="closePasswordModal()">&times;</button>
      </div>
      
      <div class="password-modal-content">
        <p>Ingrese su contraseña para ver la información del usuario</p>
        <div class="form-field">
          <label for="adminPassword" class="field-label">Contraseña:</label>
          <input
            id="adminPassword"
            type="password"
            [(ngModel)]="adminPassword"
            placeholder="Ingrese su contraseña"
            class="field-input"
            (keyup.enter)="verifyAndViewUser()"
          />
        </div>
        <div class="error-message" *ngIf="passwordError()">
          {{ passwordError() }}
        </div>
      </div>

      <div class="password-modal-actions">
        <button type="button" class="btn-cancel" (click)="closePasswordModal()">Cancelar</button>
        <button type="button" class="btn-verify" (click)="verifyAndViewUser()" [disabled]="isVerifying()">
          {{ isVerifying() ? 'Verificando...' : 'Verificar' }}
        </button>
      </div>
    </div>
  </div>
</div>
